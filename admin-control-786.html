<!DOCTYPE html>
<html>
<head>
  <title>EarnVeda Master Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {margin:0;font-family:Arial;background:#f4f6f9;}
    .topbar {background:#111;color:white;padding:15px;font-size:20px; display: flex; justify-content: space-between;}
    .container {padding:20px;}
    .cards {display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;}
    .card {
      background:white;
      padding:15px;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .card b { font-size: 22px; color: #3b82f6; }
    table { width:100%; background:white; border-collapse:collapse; margin-top:20px; }
    th, td { padding:12px; border:1px solid #ddd; text-align:center; }
    button { padding:8px 15px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
    .approve {background:green;color:white;}
    .reject {background:red;color:white;}
    .login-box { width:300px; margin:100px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); text-align:center; }
    input {width:90%;padding:10px;margin:10px 0; border: 1px solid #ccc; border-radius: 5px;}
  </style>
</head>
<body>

<div id="loginPage">
  <div class="login-box">
    <h2>Admin Login</h2>
    <input type="password" id="adminPass" placeholder="Enter Admin Password">
    <button onclick="login()" style="background: #111; color: white; width: 100%;">Login</button>
  </div>
</div>

<div id="adminPanel" style="display:none;">
  <div class="topbar">
    <span>EarnVeda Master Panel</span>
    <small style="font-size: 12px; color: #22c55e;">Live ●</small>
  </div>

  <div class="container">

    <div class="cards">
      <div class="card">Total Users <br><b id="totalUsers">0</b></div>
      <div class="card">Total Revenue <br>₹<b id="totalRevenue">0</b></div>
      <div class="card">Admin (70%) <br>₹<b id="adminShare">0</b></div>
      <div class="card">Users (30%) <br>₹<b id="userShare">0</b></div>
    </div>

    <div style="margin-top: 30px; background: white; padding: 15px; border-radius: 10px;">
      <h3>Manual Balance Update</h3>
      <input type="text" id="userPhone" placeholder="Phone Number">
      <input type="number" id="newAmount" placeholder="New Balance">
      <button class="approve" onclick="manualUpdate()">Update</button>
    </div>

    <h3>Withdrawal Requests</h3>
    <table>
      <thead>
        <tr>
          <th>Phone</th>
          <th>Amount</th>
          <th>UPI ID</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="withdrawTable">
        <tr><td colspan="4">No pending requests</td></tr>
      </tbody>
    </table>

  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLrqzCQq_i7EzWdw_aoGRvIHzgcAQFuvI",
  authDomain: "earnify-official.firebaseapp.com",
  projectId: "earnify-official",
  storageBucket: "earnify-official.firebasestorage.app",
  messagingSenderId: "392652401236",
  appId: "1:392652401236:web:00bd6e145cb6ac1f6c9bc1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let adminPassword = "786";

function login(){
  let pass = document.getElementById("adminPass").value;
  if(pass === adminPassword){
    document.getElementById("loginPage").style.display="none";
    document.getElementById("adminPanel").style.display="block";
    loadData();
  } else {
    alert("Wrong Password");
  }
}

function loadData(){

  // LIVE USERS & REVENUE
  db.collection("users").onSnapshot(snapshot => {

    document.getElementById("totalUsers").innerText = snapshot.size;

    let totalBalance = 0;

    snapshot.forEach(doc => {
      totalBalance += Number(doc.data().balance || 0);
    });

    document.getElementById("totalRevenue").innerText = totalBalance.toFixed(2);
    document.getElementById("adminShare").innerText = (totalBalance * 0.7).toFixed(2);
    document.getElementById("userShare").innerText = (totalBalance * 0.3).toFixed(2);
  });


  // LIVE WITHDRAW REQUESTS
  db.collection("withdrawals")
    .where("status","==","Pending")
    .onSnapshot(snapshot => {

      let table = document.getElementById("withdrawTable");
      table.innerHTML = "";

      if(snapshot.empty){
        table.innerHTML = "<tr><td colspan='4'>No pending requests</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        let data = doc.data();

        table.innerHTML += `
          <tr>
            <td>${data.phone}</td>
            <td>₹${data.amount}</td>
            <td>${data.upi || "Not Provided"}</td>
            <td>
              <button class="approve" onclick="approve('${doc.id}','${data.phone}',${data.amount})">Approve</button>
              <button class="reject" onclick="reject('${doc.id}')">Reject</button>
            </td>
          </tr>
        `;
      });
  });
}


// MANUAL UPDATE (works whether doc id is phone or random)
async function manualUpdate(){

  let phone = document.getElementById("userPhone").value;
  let amount = parseFloat(document.getElementById("newAmount").value);

  if(!phone || isNaN(amount)) return alert("Enter correct details");

  let snapshot = await db.collection("users")
                         .where("phone","==",phone)
                         .get();

  if(snapshot.empty){
    alert("User not found");
    return;
  }

  snapshot.forEach(async doc => {
    await db.collection("users").doc(doc.id).update({
      balance: amount
    });
  });

  alert("Balance Updated");
}


// APPROVE WITHDRAW
async function approve(id, phone, amount){

  let userQuery = await db.collection("users")
                          .where("phone","==",phone)
                          .get();

  if(userQuery.empty){
    alert("User not found");
    return;
  }

  let userDoc = userQuery.docs[0];
  let userRef = db.collection("users").doc(userDoc.id);

  await db.runTransaction(async (transaction) => {

    let userData = await transaction.get(userRef);

    let currentBalance = userData.data().balance || 0;

    if(currentBalance < amount) throw "Insufficient Balance";

    transaction.update(userRef, {
      balance: currentBalance - amount
    });

    transaction.update(
      db.collection("withdrawals").doc(id),
      { status: "Approved" }
    );
  });

  alert("Withdrawal Approved");
}


// REJECT
async function reject(id){
  await db.collection("withdrawals").doc(id).update({
    status: "Rejected"
  });

  alert("Withdrawal Rejected");
}

</script>

</body>
</html>
